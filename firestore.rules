rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.admin == true ||
        request.auth.token.email == 'pokemonstorepk@gmail.com'
      );
    }

    // Users can read/write their own user document; admins can read all
    match /users/{userId} {
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == userId);
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Orders - users can create and read their own orders, admins can read all
    match /orders/{orderId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin());
      allow update: if request.auth != null && isAdmin();
      allow delete: if request.auth != null && isAdmin();
    }
    
    // Products - public read, admin-only writes
    match /products/{productId} {
      allow read: if true;
      // Admin can write any fields
      allow write: if isAdmin();
      // Authenticated users can only decrement stock in a controlled way
      allow update: if request.auth != null &&
        // Only these fields may change
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(["stockQuantity", "inStock", "updatedAt"]) &&
        // Stock must not increase and cannot go below 0
        request.resource.data.stockQuantity is int &&
        request.resource.data.stockQuantity <= resource.data.stockQuantity &&
        request.resource.data.stockQuantity >= 0 &&
        // inStock must reflect stockQuantity > 0
        request.resource.data.inStock == (request.resource.data.stockQuantity > 0) &&
        // updatedAt must change when it exists; allow if missing on old docs
        (!resource.data.keys().hasAll(["updatedAt"]) || request.time > resource.data.updatedAt);
    }
    
    // Categories - public read, admin-only writes
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Reviews - public read, users can create their own, admin/user can update/delete
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.userId || request.auth.token.admin == true);
    }
  }
}
